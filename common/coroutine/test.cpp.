/*
 * =====================================================================================
 *
 *       Filename:  test.cpp
 *
 *    Description:  test
 *
 *        Version:  1.0
 *        Created:  07/27/2017 17:21:29 PM
 *       Revision:  none
 *       Compiler:  g++
 *
 *         Author:  huangyun.goddard (), 895175589@qq.com
 *   Organization:  
 *
 * =====================================================================================
 */

#include "coroutine.h"
#include <cstdio>
#include <cstdlib>
#include <unistd.h>

using namespace goddard;

void fun1(void *s)
{
	puts("fun1 111");
	coroutine_yield((schedule *)s);
	puts("fun1 222");
	coroutine_yield((schedule *)s);
	puts("fun1 333");
	coroutine_yield((schedule *)s);
	puts("fun1 444");
	coroutine_yield((schedule *)s);
	puts("fun1 555");
}

void fun2(void *s)
{
	puts("fun2 111");
	coroutine_yield((schedule *)s);
	puts("fun2 222");
	coroutine_yield((schedule *)s);
	puts("fun2 333");
	coroutine_yield((schedule *)s);
	puts("fun2 444");
	coroutine_yield((schedule *)s);
	puts("fun2 555");
}

#define MAX_COROUTINE_SIZE 10000

int main()
{
	schedule s;
	schedule_init(&s);

	int count = 0;

	while (1)
	{
		if (count < MAX_COROUTINE_SIZE)
		{
			coroutine_create(&s, fun1, (void *)&s);
			++count;
		}
		int r = random() % count;
		printf("coroutine_resume %d\n", r);
		coroutine_resume(&s, r);
		usleep(100);
	}
}
